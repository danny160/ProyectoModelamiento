<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulación Energética — Animada (D3)</title>

  <!-- D3 v7 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    :root{
      --bg:#f3f6fc;
      --card:#ffffff;
      --accent:#3d7bfd;
      --accent-2:#09cba3;
      --muted:#7c849c;
      --text:#25386b;
    }
    html,body{height:100%}
    body {
      margin: 16px;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container {
      max-width: 1100px;
      margin: 12px auto;
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 8px 28px rgba(84,106,220,0.07);
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header h1 { margin:0; font-size:1.25rem; color:var(--text); }
    .control-restart {
      opacity:0;
      pointer-events:none;
      transition: opacity 240ms;
    }
    .control-restart.visible {
      opacity:1;
      pointer-events:auto;
    }
    .restart-btn {
      background: transparent;
      border: 1px solid rgba(37,56,107,0.12);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight:700;
      color:var(--text);
    }
    .row { display:flex; gap:18px; margin-top:16px; align-items:flex-start; flex-wrap:wrap; }
    .col { flex:1; min-width:260px; }
    .chart-wrap {
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius:10px;
      padding:12px;
      box-shadow: 0 8px 22px rgba(16, 45, 101, 0.04);
      position:relative;
      overflow:hidden;
    }

    /* Dynamic background overlay that changes color with consumption */
    .dynamic-bg {
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0.12;
      transition: background 600ms ease;
      border-radius:10px;
    }

    .indicators {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
      margin-top:10px;
    }
    .card-ind {
      background:#f7f9ff;
      border-radius:8px;
      padding:10px;
    }
    .label { font-size:0.85rem; color:var(--muted); }
    .value { font-size:1.15rem; font-weight:700; color:var(--text); margin-top:6px; }

    .small-controls { display:flex; gap:8px; margin-top:10px; align-items:center; }
    .btn { background:var(--accent); color:white; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn.alt { background:var(--accent-2); }

    .svg-container { width:100%; height:380px; }

    footer { margin-top:14px; display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:0.9rem; }

    /* small LED point */
    .led {
      filter: drop-shadow(0 0 6px rgba(61,123,253,0.45));
    }

    /* micro animation when hitting restart */
    .pulse {
      animation: pulseAnim 700ms ease;
    }
    @keyframes pulseAnim {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    /* Responsive tweaks */
    @media (max-width:880px){
      .indicators { grid-template-columns: 1fr; }
      .col { min-width:unset; width:100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>Simulación animada — consumo acumulado (kWh)</h1>
        <div class="control-restart" id="restartControl">
          <button id="restartBtn" class="restart-btn" title="Reiniciar simulación">↻ Reiniciar</button>
        </div>
      </header>

      <div class="row" style="margin-top:14px;">
        <div class="col">
          <div class="chart-wrap" id="chartWrap">
            <div class="dynamic-bg" id="dynamicBg"></div>
            <div id="svgRoot" class="svg-container"></div>
          </div>

          <footer>
            <div class="muted">Cada segundo = 1 hora simulada · Datos tomados desde tu formulario y modal</div>
            <div>
              <button id="backBtn" class="btn alt">Volver</button>
            </div>
          </footer>
        </div>

        <div class="col" style="max-width:360px;">
          <div class="card-ind">
            <div class="label">Horas a simular</div>
            <div id="hoursVal" class="value">-- h</div>
          </div>

          <div class="indicators">
            <div class="card-ind">
              <div class="label">Consumo acumulado (Wh)</div>
              <div id="accWh" class="value">--</div>
            </div>
            <div class="card-ind">
              <div class="label">Consumo acumulado (kWh)</div>
              <div id="accKwh" class="value">--</div>
            </div>

            <div class="card-ind">
              <div class="label">Costo diario (COP)</div>
              <div id="costDay" class="value">--</div>
            </div>
            <div class="card-ind">
              <div class="label">CO₂ generado (kg)</div>
              <div id="co2" class="value">--</div>
            </div>

            <div class="card-ind">
              <div class="label">Costo semanal (COP)</div>
              <div id="costWeek" class="value">--</div>
            </div>
            <div class="card-ind">
              <div class="label">Costo mensual (COP)</div>
              <div id="costMonth" class="value">--</div>
            </div>
          </div>

          <div class="small-controls">
            <button id="playPauseBtn" class="btn" style="display:none;">Pausa</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* Simulación animada con D3 (mejorada)
   - Lee payload desde localStorage (simulator_payload)
   - payload: { horas, kwhPrice, devices: [{label, active, count, watts}, ...] }
   - Cada segundo = 1 hora simulada
   - kWh por hora por dispositivo = (watts * count) / 1000
   - Animaciones: línea que se "dibuja", punto móvil (LED), interpolación suave de números,
                 fondo dinámico que cambia color según carga.
*/

(function(){
  const raw = localStorage.getItem("simulator_payload");
  if(!raw){
    document.body.innerHTML = '<div style="padding:40px;text-align:center">No hay datos de configuración. Vuelve a la página principal y pulsa "Iniciar Simulación".</div>';
    return;
  }

  const payload = JSON.parse(raw);
  const horas = Math.max(1, Number(payload.horas) || 1);
  const kwhPrice = Number(payload.kwhPrice) || 0;
  const devices = payload.devices || [];

  // ---- Preparación métricas ----
  const activeDevices = devices.filter(d => d.active && Number(d.count) > 0 && Number(d.watts) > 0);

  // kWh added per simulated hour (constant)
  const kwhPerHour = activeDevices.reduce((sum, d) => sum + (Number(d.watts) * Number(d.count) / 1000), 0);
  const whPerHour = kwhPerHour * 1000;
  const CO2_FACTOR = 0.43; // kg CO2 / kWh

  // DOM refs
  const hoursVal = document.getElementById("hoursVal");
  const accWhEl = document.getElementById("accWh");
  const accKwhEl = document.getElementById("accKwh");
  const costDayEl = document.getElementById("costDay");
  const costWeekEl = document.getElementById("costWeek");
  const costMonthEl = document.getElementById("costMonth");
  const co2El = document.getElementById("co2");
  const restartControl = document.getElementById("restartControl");
  const restartBtn = document.getElementById("restartBtn");
  const backBtn = document.getElementById("backBtn");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const dynamicBg = document.getElementById("dynamicBg");
  const chartWrap = document.getElementById("chartWrap");

  hoursVal.textContent = horas + " h";

  const fmtCOP = v => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(Math.round(v));
  const fmtNum = (v, dp=2) => Number(v).toLocaleString('es-CO', { minimumFractionDigits: dp, maximumFractionDigits: dp });

  // ---- D3 Chart init ----
  const margin = {top: 18, right: 26, bottom: 36, left: 64};
  const container = d3.select("#svgRoot");
  const width = container.node().clientWidth;
  const height = 380;
  const svg = container.append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("viewBox", `0 0 ${width} ${height}`);

  const plotW = width - margin.left - margin.right;
  const plotH = height - margin.top - margin.bottom;
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

  // scales
  const x = d3.scaleLinear().domain([1, Math.max(2, horas)]).range([0, plotW]);
  const maxExpected = Math.max(kwhPerHour * horas, 0.001);
  const y = d3.scaleLinear().domain([0, maxExpected * 1.12]).range([plotH, 0]);

  const xAxis = d3.axisBottom(x).ticks(Math.min(horas, 12)).tickFormat(d => `${d}h`);
  const yAxis = d3.axisLeft(y).ticks(6).tickFormat(d => d.toFixed(2) + " kWh");

  const gx = g.append("g").attr("transform", `translate(0,${plotH})`).call(xAxis);
  const gy = g.append("g").call(yAxis);

  // grid lines
  g.append("g")
    .attr("class","grid")
    .selectAll("line")
    .data(y.ticks(6))
    .enter()
    .append("line")
    .attr("x1",0).attr("x2",plotW)
    .attr("y1",d => y(d)).attr("y2",d => y(d))
    .attr("stroke","#eef4ff")
    .attr("stroke-width",1);

  // area and line definitions
  const area = d3.area().x(d => x(d.hour)).y0(plotH).y1(d => y(d.kwh)).curve(d3.curveMonotoneX);
  const line = d3.line().x(d => x(d.hour)).y(d => y(d.kwh)).curve(d3.curveMonotoneX);

  const areaPath = g.append("path").attr("fill", "rgba(61,123,253,0.12)").attr("opacity",0.95);
  const linePath = g.append("path").attr("fill","none").attr("stroke", "url(#lineGradient)").attr("stroke-width",2.6);
  // gradient stroke for line
  const defs = svg.append("defs");
  const grad = defs.append("linearGradient").attr("id","lineGradient").attr("x1","0%").attr("x2","100%");
  grad.append("stop").attr("offset","0%").attr("stop-color","#09cba3");
  grad.append("stop").attr("offset","100%").attr("stop-color","#3d7bfd");

  // moving point (LED)
  const led = g.append("circle").attr("r",5).attr("class","led").attr("fill","#3d7bfd").attr("cx", -10).attr("cy", plotH);

  // label bubble near the LED
  const labelGroup = g.append("g").attr("transform", `translate(10,10)`).style("opacity",0);
  labelGroup.append("rect").attr("width",120).attr("height",36).attr("rx",8).attr("fill","#ffffff").attr("stroke","#e6eefc");
  const labelText = labelGroup.append("text").attr("x",8).attr("y",20).attr("fill","#25386b").style("font-size","12px").style("font-weight","700");

  // axes labels
  svg.append("text").attr("x", margin.left + 6).attr("y", margin.top - 6).attr("fill", "#7c849c").style("font-size","12px").text("Consumo acumulado (kWh)");

  // initial empty data
  let data = [];

  // simulate state
  let hourIndex = 0;
  let running = true;
  let intervalId = null;

  // helpers
  function computeTotals(currentKwh) {
    const dailyKwh = currentKwh; // currentKwh interpreted as kWh/day per earlier convention
    const costDay = dailyKwh * kwhPrice;
    const costWeek = costDay * 7;
    const costMonth = costDay * 30;
    const co2 = dailyKwh * CO2_FACTOR;
    return { dailyKwh, costDay, costWeek, costMonth, co2 };
  }

  // smooth numeric transition with d3
  function animateNumber(el, start, end, duration=650, formatFn = v => v) {
    const interpolator = d3.interpolateNumber(start, end);
    const t0 = performance.now();
    function tick(now){
      const t = Math.min(1, (now - t0) / duration);
      el.textContent = formatFn(interpolator(t));
      if(t < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function updateNumbers(kwhAcc) {
    const whAcc = kwhAcc * 1000;
    const t = computeTotals(kwhAcc);
    animateNumber(accWhEl, parseFloat(accWhEl._val || 0), Math.round(whAcc), 700, v => v.toLocaleString('es-CO') + " Wh");
    animateNumber(accKwhEl, parseFloat(accKwhEl._val || 0), Number(kwhAcc), 700, v => Number(v).toFixed(3) + " kWh");
    animateNumber(costDayEl, parseFloat(costDayEl._val || 0), t.costDay, 700, v => fmtCOP(v));
    animateNumber(costWeekEl, parseFloat(costWeekEl._val || 0), t.costWeek, 700, v => fmtCOP(v));
    animateNumber(costMonthEl, parseFloat(costMonthEl._val || 0), t.costMonth, 700, v => fmtCOP(v));
    animateNumber(co2El, parseFloat(co2El._val || 0), t.co2, 700, v => Number(v).toFixed(3) + " kg");

    // store last values for next interpolation
    accWhEl._val = Math.round(whAcc);
    accKwhEl._val = Number(kwhAcc);
    costDayEl._val = t.costDay;
    costWeekEl._val = t.costWeek;
    costMonthEl._val = t.costMonth;
    co2El._val = t.co2;
  }

  // update background color based on load ratio (0..1)
  function updateBackground(kwhAcc) {
    const maxExpected = Math.max(kwhPerHour * horas, 0.001);
    const ratio = Math.min(1, kwhAcc / maxExpected);
    // green -> yellow -> red
    let color;
    if(ratio < 0.5) {
      // greenish to bluish
      const gComp = Math.round(200 + ratio * 55);
      color = `linear-gradient(180deg, rgba(9,203,163,${0.09 + ratio*0.14}), rgba(61,123,253,${0.06 + ratio*0.09}))`;
    } else if(ratio < 0.85) {
      color = `linear-gradient(180deg, rgba(255,223,93,${0.09 + ratio*0.12}), rgba(61,123,253,${0.05 + ratio*0.08}))`;
    } else {
      color = `linear-gradient(180deg, rgba(255,92,92,${0.10 + ratio*0.15}), rgba(61,123,253,${0.04 + ratio*0.06}))`;
    }
    dynamicBg.style.background = color;
  }

  // update axes if y max increases
  function updateScalesAndAxes(maxKwh) {
    const newMax = Math.max(maxKwh * 1.12, 0.001);
    y.domain([0, newMax]);
    // update y axis and grid
    gy.transition().duration(450).call(d3.axisLeft(y).ticks(6).tickFormat(d => d.toFixed(2) + " kWh"));
    g.selectAll(".grid").selectAll("line")
      .data(y.ticks(6))
      .join("line")
      .transition().duration(450)
      .attr("x1",0).attr("x2",plotW)
      .attr("y1",d => y(d)).attr("y2",d => y(d));
  }

  // render chart: area, line, points
  function renderChart() {
    // update x domain
    x.domain([1, Math.max(2, horas)]);
    gx.transition().duration(250).call(d3.axisBottom(x).ticks(Math.min(horas,12)).tickFormat(d => `${d}h`));

    // update paths
    areaPath.datum(data).transition().duration(500).attr("d", area);
    linePath.datum(data).transition().duration(500).attr("d", line);

    // update points
    const pts = g.selectAll(".point").data(data, d => d.hour);
    pts.join(
      enter => enter.append("circle")
                    .attr("class","point")
                    .attr("cx", d => x(d.hour))
                    .attr("cy", d => y(d.kwh))
                    .attr("r", 2.4)
                    .attr("fill", "#3d7bfd")
                    .attr("opacity",0)
                    .call(en => en.transition().duration(500).attr("opacity",1)),
      update => update.call(u => u.transition().duration(450).attr("cx", d => x(d.hour)).attr("cy", d => y(d.kwh))),
      exit => exit.remove()
    );
  }

  // move LED smoothly along the current point (and label)
  function moveLedToLatest() {
    if(!data.length) {
      led.attr("cx", -10).attr("cy", plotH);
      labelGroup.style("opacity",0);
      return;
    }
    const latest = data[data.length -1];
    const lx = x(latest.hour);
    const ly = y(latest.kwh);

    // move LED with transition
    led.transition().duration(600).attr("cx", lx).attr("cy", ly);

    // show label near LED (with value)
    labelGroup.transition().duration(400).style("opacity",1).attr("transform", `translate(${Math.min(plotW - 140, lx + 12)},${Math.max(6, ly - 26)})`);
    labelText.text(`${latest.kwh.toFixed(3)} kWh`);
  }

  // draw line stroke animation (draw from 0 to full) for visible effect
  function animateLineDraw() {
    const pathEl = linePath.node();
    try {
      const totalLen = pathEl.getTotalLength();
      linePath
        .attr("stroke-dasharray", `${totalLen} ${totalLen}`)
        .attr("stroke-dashoffset", totalLen)
        .transition().duration(700).ease(d3.easeCubicOut)
        .attr("stroke-dashoffset", 0);
    } catch(e) {
      // some browsers may throw if path invalid; ignore
    }
  }

  // simulation step
  function stepSimulation() {
    if(!running) return;
    if(hourIndex >= horas){
      // finished
      clearInterval(intervalId);
      intervalId = null;
      running = false;
      restartControl.classList.add("visible");
      playPauseBtn.style.display = "none";
      // final pulse
      chartWrap.classList.add("pulse");
      setTimeout(()=> chartWrap.classList.remove("pulse"),700);
      return;
    }
    hourIndex += 1;
    const prevKwh = data.length ? data[data.length -1].kwh : 0;
    const newKwh = prevKwh + kwhPerHour;
    data.push({ hour: hourIndex, kwh: newKwh });

    // if data length exceeds horas for display, keep them all (we allow full domain 1..horas)
    // update chart scale if needed
    const maxKwh = d3.max(data, d => d.kwh) || kwhPerHour;
    updateScalesAndAxes(maxKwh);

    renderChart();
    animateLineDraw();
    moveLedToLatest();
    updateNumbers(newKwh);
    updateBackground(newKwh);
  }

  // start simulation
  function startSimulation() {
    data = [];
    hourIndex = 0;
    running = true;
    restartControl.classList.remove("visible");
    playPauseBtn.style.display = "inline-block";
    playPauseBtn.textContent = "Pausa";

    // reset visuals
    linePath.attr("d", null);
    areaPath.attr("d", null);
    led.attr("cx", -10).attr("cy", plotH);
    labelGroup.style("opacity",0);
    updateNumbers(0);
    updateBackground(0);
    renderChart();

    // first step immediately so user sees movement
    stepSimulation();
    intervalId = setInterval(stepSimulation, 1000);
  }

  function stopSimulation() {
    running = false;
    if(intervalId) clearInterval(intervalId);
    intervalId = null;
    playPauseBtn.textContent = "Reanudar";
  }

  restartBtn.addEventListener("click", () => {
    startSimulation();
  });

  playPauseBtn.addEventListener("click", () => {
    if(running) stopSimulation();
    else {
      running = true;
      if(!intervalId) intervalId = setInterval(stepSimulation, 1000);
      playPauseBtn.textContent = "Pausa";
    }
  });

  backBtn.addEventListener("click", () => window.close());

  // no devices => show message and zeros
  if(activeDevices.length === 0) {
    d3.select("#svgRoot").append("div")
      .style("padding","18px")
      .style("color", "#6b7280")
      .style("font-size","0.98rem")
      .text("No hay dispositivos activos o los consumos (watts) son 0. Activa equipos y define su consumo en el modal.");
    updateNumbers(0);
  } else {
    // kick off
    startSimulation();
  }

})();
</script>
</body>
</html>
